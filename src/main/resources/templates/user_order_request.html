 <!DOCTYPE html >
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
   <head>
      <!-- basic -->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- mobile metas -->
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="viewport" content="initial-scale=1, maximum-scale=1">
      <!-- site metas -->
      <title>발주요청입력</title>
      <meta name="keywords" content="">
      <meta name="description" content="">
      <meta name="author" content="">
      <!-- site icon -->
      <link rel="icon" href="/images/fevicon.png" type="image/png" />
      <!-- bootstrap css -->
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
      <!-- site css -->
      <link rel="stylesheet" href="/css/style.css" />
      <!-- responsive css -->
      <link rel="stylesheet" href="/css/responsive.css" />
      <!-- color css -->
      <!-- <link rel="stylesheet" href="/css/color_2.css" />  -->
      <link rel="stylesheet" href="/css/color_2.css" />
      <!-- select bootstrap -->
      <link rel="stylesheet" href="/css/bootstrap-select.css" />
      <!-- scrollbar css -->
      <link rel="stylesheet" href="/css/perfect-scrollbar.css" />
      <!-- custom css -->
      <link rel="stylesheet" href="/css/custom.css" />
      <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
      <![endif]-->
    
      <!-- <link rel="stylesheet" type="text/css" th:href="@{/bootstrap.min.css}">  -->
   
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
      <link rel="stylesheet" type="text/css" th:href="@{/bootstrap.min.css}">
   
         <!-- Bootstrap CSS -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
   
  
  
  <style>
  
     	   html, body {
    		font-family: 'Poppins', 'Noto Sans KR', sans-serif !important;
		}
		
#modalOpenButton, #modalCloseButton {
   cursor: pointer;
}

#searchModalContainer {
   width: 100%;
   height: 100%;
   position: fixed;
   top: 0;
   left: 0;
   display: flex;
   justify-content: center;
   align-items: center;
   background: rgba(0, 0, 0, 0.5);
}

#searchModalContent {
   position: absolute;
   background-color: #ffffff;
   width: 1000px;
   border-radius: 10px;
   scrollbar-width: none;
}

#searchModalContainer.hidden {
   display: none;
}

.table.product-list-table {
   /* 테이블 내부 정렬 */
   width: 100%; /* 너비를 100%로 설정 */
   table-layout: fixed; /* 테이블 레이아웃을 고정으로 설정 */
   border-collapse: collapse; /* 테이블 셀 사이의 경계선 겹침 방지 */
}

/* 헤더 셀 스타일 */
.table.product-list-table th {
   vertical-align: middle;
   background-color: #f8f9fa; /* 연한 배경색 */
   text-align: center; /* 텍스트 가운데 정렬 */
   padding: 10px; /* 여백 추가 */
}

/* 본문 셀 스타일 */
.table.product-list-table td {
   vertical-align: middle;
   padding: 10px; /* 여백 추가 */
   text-align: center; /* 텍스트 가운데 정렬 */
   border: 1px solid #ddd; /* 테이블 셀에 경계선 추가 */
}

/* 'NO', '품목코드', '품목명', '발주 수량', '단가', '총 금액' 같은 헤더 항목에 굵은 테두리 추가 */
.table.product-list-table th, .table.product-list-table td {
   border: 1px solid #dee2e6;
}

/* 'NO', '품목코드', '품목명', '발주 수량', '단가', '총 금액' 항목을 가운데 정렬 */
.table.product-list-table th {
   font-weight: bold;
}

/* 테이블 내에서 'input' 필드 크기 조정 */
.table.product-list-table td input[type="number"] {
   width: 60px; /* 수량 입력란의 너비 */
   padding: 5px; /* 패딩으로 여백 추가 */
   text-align: center; /* 텍스트 가운데 정렬 */
   margin: 0 auto; /* 가운데 정렬 */
}

.table.table-bordered th, .table.table-bordered td {
   vertical-align: middle;
}

.modal-body::-webkit-scrollbar {
   width: 10px;
}

.modal-body::-webkit-scrollbar-thumb {
   background-color: grey;
   border-radius: 10px;
   background-clip: padding-box;
   border: 2px solid transparent;
}

.modal-body::-webkit-scrollbar-track {
   background-color: #fff;
   border-radius: 10px;
   box-shadow: inset 0px 0px 5px white;
}
</style>

   
  
  
  
         
   
   </head>
   <body class="dashboard dashboard_1">
      <div class="full_container">
         <div class="inner_container">
            <head th:include="fragments/user_sidebar :: sidebar"></head>
            <!-- right content -->
            <div id="content">
               <head th:include="fragments/user_topbar :: topbar"></head>
            	            	<div class="page_title" style="margin-bottom: 0px;">
                   <h2 style="margin-bottom: 0px;">발주요청입력</h2>
                </div>

         <!-- 메인 내용 -->
                 <div class="main p-5">
<!--             <h6>
               <strong>발주요청</strong>
            </h6> -->
            <form action="/user/order/request" method="post">
               <table class="table table-bordered">
                   <tr>
                     <th>납기일자</th>
                     <td>
                        <input type="date" id="startDate_2" name="order_delivery"> 
                     </td>   
                  </tr>
                  <tr>
                     <th>담당자</th>
                        <td><input type="text" id="branch_owner"  name="order_manager" ></td>
                     <th>점포명</th>
                        <td><input type="text" id="branch_name" name="order_sender"></td>
                  </tr>
           
            <tr>
               <th>참조</th>
                  <td >
                     <input type="text" id="memo" name="order_memo">
                  </td>
               <th>발주아이디</th>
                  <td>
                     <input type="text" id="order_id"  name="order_id" >
                  </td>
                     
            
            </tr>
         </table>
         <div style="text-align: right;">
           <button type="button" class="btn btn-secondary btn-sm" style="border-radius: 8px; background-color:#04AA6D; border-color:#04AA6D; width: 120px " onclick="openSearchModal()">
                상품추가
             </button>
   
 
        </div>
      <div class="wrapper mt-5" id="productListContainer">
         <table class="table product-list-table">
            <thead>
               <tr>
                  <th class="table-light text-center">NO</th>
                  <th class="table-light text-center">품목코드</th>
                  <th class="table-light text-center">품목명</th>
                  <th class="table-light text-center">발주 수량</th>
                  <th class="table-light text-center">단가</th>
                  <th class="table-light text-center">총 금액</th>
                  <th class="table-light text-center">물품 취소</th>
                  
               </tr>
            </thead>
                 <tbody id="orderListBody">
                <!-- 검색 결과 데이터가 여기에 추가됨 -->
            </tbody>
         </table>
      <div style="display: flex; justify-content: space-between; align-items: center;">
   <!-- 왼쪽: 버튼 -->
   <div>
      <button type="submit" class="btn btn-primary btn-sm" style="width: 70px; border-radius: 8px; ">요청</button>
      <button type="reset" class="btn btn-secondary btn-sm" style="width: 70px; border-radius: 8px;">초기화</button>
   </div>

   <!-- 오른쪽: 합계 박스 -->
   <div style="display: flex; align-items: center; gap: 5px; text-align: right; margin-top: 20px;">
      <div style="text-align: right; margin-top: 20px;">
       <span id="currency" style="font-size: 16px; font-weight: bold; display: none;">총 금액:</span>
	   <input id="totalAmount" name="order_sum" readonly style="border: none; background: none; text-align: right; font-size: 16px; font-weight: bold; width: 100px;">
	   <span id="currency_1" style="font-size: 16px; font-weight: bold; display: none;">원</span>
</div>
  </form>     
      </div>
               
   <!-- 메인 내용 END -->
            </div>
         </div>
      </div>
      
            <!-- 상품 검색 모달 -->
<div id="searchModalContainer" class="hidden">
    <div id="searchModalContent" style="overflow-y: auto;">
        <!-- 닫기 버튼 -->
        <div style="background-color:#04AA6D; border-radius: 10px 10px 0 0; padding: 15px; text-align: left; float: center;">
                 <h4 style="text-align: left; display: inline-block; margin: 0 0 0 10px; width: 95%; color: white; font-size: 15px;">발주 상품 추가</h4>
                 <button type="button" id="searchModalCloseButton" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: rgb(192, 192, 192); font-weight: bold; text-align: right;"></button>
        </div>
        
        <!-- 제목 -->
        <div style="margin: 10px; text-align: center;">
            <h4>상품 검색</h4>
        </div>
        
        <!-- 검색 입력 및 버튼 -->
        <div style="margin: 20px; text-align: center;">
            <input id="searchInput" type="text" placeholder="상품명을 입력하세요" style="width: 60%; margin-right: 10px;">
            <button id="searchButton" class="btn btn-primary">검색</button>
        </div>
        
        <!-- 검색 결과 테이블 -->
        <div id="searchResultsContainer" class="modal-body" style="padding: 30px; max-height: 600px; overflow-y: auto;">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>상품코드</th>
                        <th>상품명</th>
                        <th>가격</th>
						<th>선택</th>
                    </tr>
                </thead>
                <tbody id="searchResultsBody">
                    <!-- 검색 결과가 여기 추가됩니다 -->
                </tbody>
            </table>
        </div>
    </div>
</div>
      
      
      
      
      
      
      
      
      
      
      <script>
      
      document.querySelector('button[type="submit"]').addEventListener('click', function (e) {
           e.preventDefault(); // 기본 폼 제출 방지

           // OrderDTO 데이터 수집
           const orderDTO = {
               order_id: document.querySelector('input[name="order_id"]').value,
               order_sender: document.querySelector('input[name="order_sender"]').value,
               order_delivery: document.querySelector('input[name="order_delivery"]').value,
               order_sum: parseInt(document.getElementById('totalAmount').value.replace(/,/g, ''), 10),
               order_manager: document.querySelector('input[name="order_manager"]').value,
               order_memo: document.querySelector('input[name="order_memo"]').value,
           };

           // OrderDetailDTO 데이터 수집
           const orderDetails = [];
           document.querySelectorAll('#orderListBody tr').forEach((row) => {
               const productId = row.querySelector('td:nth-child(2)').textContent.trim();
               const quantity = parseInt(row.querySelector('input[name="quantity"]').value, 10);
               const price = parseInt(row.querySelector('td:nth-child(5)').textContent.replace(/,/g, ''), 10);
               const sum = price * quantity;

               orderDetails.push({
                   orderDetail_productid: productId,
                   orderDetail_amount: quantity,
                   orderDetail_price: price,
                   orderDetail_sum: sum,
               });
           });

           // Ajax 요청 보내기
           $.ajax({
               url: '/user/order/request',
               method: 'POST',
               contentType: 'application/json',
               data: JSON.stringify({
                   orderDTO: orderDTO,
                   orderDetails: orderDetails,
               }),
               success: function (response) {
                   alert('발주 요청이 성공적으로 저장되었습니다!');
                   window.location.href = '/user/order/request';
               },
               error: function (error) {
                   alert('오류 발생: ' + error.responseText);
				   console.log(error.responseText);
               },
           });
       });
      
      
      
      
      
       // 모달 검색 결과의 tbody ID
      const searchResultsBody = document.getElementById('searchResultsBody');

      // 기존 페이지 선택된 값 추가될 tbody ID
      const orderListBody = document.getElementById('orderListBody');
      
      
      
      document.getElementById('searchResultsBody').addEventListener('click', function (e) {
           if (e.target.tagName === 'BUTTON' && e.target.dataset.product) {
               const product = JSON.parse(e.target.dataset.product);
               addToOrderList(product);
           }
       });
      
      
      
   // 모달 열기
      function openSearchModal() {
          const modal = document.getElementById('searchModalContainer');
          modal.classList.remove('hidden'); // hidden 클래스 제거 -> 모달 표시
      }

      // 모달 닫기
      document.getElementById('searchModalCloseButton').addEventListener('click', function () {
          const modal = document.getElementById('searchModalContainer');
          modal.classList.add('hidden'); // hidden 클래스 추가 -> 모달 숨기기
      });

      
      function addToOrderList(product) {
           const productListContainer = document.querySelector('#productListContainer tbody');

           // 중복 체크: 상품 코드로 비교
           const existingRows = Array.from(productListContainer.querySelectorAll('tr'));
           const isDuplicate = existingRows.some(row => row.dataset.productCode === product.product_code);

           if (isDuplicate) {
               alert('이미 추가된 상품입니다.');
               return;
           
            // 모달 닫기
              const modal = document.getElementById('searchModalContainer');
              modal.classList.add('hidden');
               
               
           }

           // 새로운 행 추가
           const newRow = document.createElement('tr');
           newRow.dataset.productCode = product.product_code; // 중복 방지를 위한 데이터 속성
           newRow.innerHTML = `
               <td>${productListContainer.children.length + 1}</td>
               <td>${product.product_id}</td>
               <td>${product.product_name}</td>
               <td>
                   <input type="number" name="quantity" value="1" min="1" class="form-control" style="width: 80px; padding: 5px; font-size: 14px; text-align: center; ">
               </td>
               <td>${Number(product.product_price).toLocaleString()}</td>
               <td>
                   <span class="total-price">${Number(product.product_price).toLocaleString()}</span>
               </td>
               <td>
                   <button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); updateTotal();">삭제</button>
               </td>
           `;

           productListContainer.appendChild(newRow);
           
           
        // 수량 변경 이벤트 추가
           newRow.querySelector('input[name="quantity"]').addEventListener('change', function () {
               updateRowTotal(newRow); // 개별 총합 갱신
               updateTotal(); // 전체 총합 갱신
           });
           
		   updateRowTotal(newRow);

           // 합계 업데이트
           updateTotal();
       }
	   
	   
	   function updateRowTotal(row) {
	       const price = parseInt(row.querySelector('td:nth-child(5)').textContent.replace(/,/g, ''), 10); // 가격 가져오기
	       const quantity = parseInt(row.querySelector('input[name="quantity"]').value, 10); // 수량 가져오기
	       const totalPrice = price * quantity; // 총 금액 계산

	       // 천 단위 콤마 추가
	       row.querySelector('.total-price').textContent = totalPrice.toLocaleString(); // 개별 금액 업데이트
	   }
	   
   
      
      // 검색 기능
      document.getElementById('searchButton').addEventListener('click', function () {
          const productName = document.getElementById('searchInput').value;

          if (productName.trim() === '') {
              alert('상품명을 입력하세요!');
              return;
          }

          // Ajax 요청
          $.ajax({
              url: '/user/order/request/detail',
              method: 'GET',
              data: { product_name: productName },
              success: function (result) {
                  const tbody = document.getElementById('searchResultsBody');
                  tbody.innerHTML = ''; // 기존 결과 초기화

                  if (result && result.length > 0) {
                      // 결과 표시
                      result.forEach((product) => {
                          const tr = document.createElement('tr');
                          tr.innerHTML = `
                              <td>${product.product_id}</td>
                              <td>${product.product_name}</td>
                              <td>${product.product_price.toLocaleString()}</td>
                             <td>
                              <button class="btn btn-primary btn-sm" style="background-color:#04AA6D; border-color:#04AA6D;"  data-product='${JSON.stringify(product)}'>선택</button>
                          </td>
                          `;
                          tbody.appendChild(tr);
                      });
                      
                      
                      
                      
                      
                  } else {
                     tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">검색 결과가 없습니다.</td></tr>';
                  }
              },
              error: function () {
                  alert('검색 중 오류가 발생했습니다.');
              }
          });
      });
      
      
   // 수량 변경 이벤트 추가
      document.getElementById('orderListBody').addEventListener('change', function (e) {
		if (e.target.name === 'quantity') {
		        const row = e.target.closest('tr'); // 현재 수량이 변경된 행 찾기
		        updateRowTotal(row); // 해당 행의 총합 업데이트
		        updateTotal(); // 전체 합계 업데이트
		    }
      });
      
     
      
   // 총합 계산 함수
      function updateTotal() {
          const rows = document.querySelectorAll('#orderListBody tr');
          let total = 0;

		  rows.forEach(row => {
		         const price = parseInt(row.querySelector('td:nth-child(5)').textContent.replace(/,/g, ''), 10); // 쉼표 제거 후 숫자로 변환
		         const quantity = parseInt(row.querySelector('input[name="quantity"]').value, 10);
		         total += price * quantity;
		     });
			 
			 const totalAmount = document.getElementById('totalAmount');
			 const currencySpan = document.getElementById('currency');
			 const currencySpan_1 = document.getElementById('currency_1');

			 if (total > 0) {
			         totalAmount.value = total.toLocaleString(); // 값이 있을 경우 총액 표시
			         currencySpan.style.display = 'inline'; // '원' 표시
					 currencySpan_1.style.display = 'inline'; 
			     } else {
			         totalAmount.value = ''; // 값이 없을 경우 입력값 비우기
			         currencySpan.style.display = 'none'; // '원' 숨기기
			     }
      }
      
      
      
      </script>
      
      
      
     
       <!-- Bootstrap JS + Popper -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
      
      <!-- jQuery -->
      <!--  <script src="/js/jquery.min.js"></script>--> 
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script src="/js/popper.min.js"></script>
      <script src="/js/bootstrap.min.js"></script>
      <!-- wow animation -->
      <script src="/js/animate.js"></script>
      <!-- select country -->
      <script src="/js/bootstrap-select.js"></script>
      <!-- owl carousel -->
      <script src="/js/owl.carousel.js"></script> 
      <!-- chart js -->
      <script src="/js/Chart.min.js"></script>
      <script src="/js/Chart.bundle.min.js"></script>
      <script src="/js/utils.js"></script>
      <script src="/js/analyser.js"></script>
      <!-- nice scrollbar -->
      <script src="/js/perfect-scrollbar.min.js"></script>
      <script>
         var ps = new PerfectScrollbar('#sidebar');
      </script>
      <!-- custom js -->
      <script src="/js/chart_custom_style1.js"></script>
      <script src="/js/custom.js"></script> 
   </body>
</html>